---
name: post

"on":
  push:
    branches:
      - master
    paths-ignore:
      - LICENSE
      - README.md
      - '.github/workflows/*'
      - '.github/dependabot.yaml'

permissions:
  contents: read

jobs:
  post:
    name: post changes
    runs-on: ubuntu-latest
    environment:
      name: prose.sh
      url: https://andros21.prose.sh
    steps:
      - name: checkout project
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9
        with:
          fetch-depth: 0
      - name: get changes
        id: changed-files
        uses: tj-actions/changed-files@920e7b9ae1d45913fc81f86c956fee89c77d2e5e
      - name: post prose.sh
        if: steps.changed-files.outputs.all_changed_files_count > 0
        shell: bash
        run: |
          set -x
          # setup ssh-agent
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.PROSE_PRV_KEY }}"
          # post changed files
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            scp -o StrictHostKeyChecking=no -v "$file" andros21@prose.sh:
          done
      - name: purge prose.sh
        if: steps.changed-files.outputs.deleted_files_count > 0
        shell: bash
        run: |
          # purge deleted files
          for file in ${{ steps.changed-files.outputs.deleted_files }}; do
            cp /dev/null "$file"
            scp -o StrictHostKeyChecking=no -v "$file" andros21@prose.sh:
          done
